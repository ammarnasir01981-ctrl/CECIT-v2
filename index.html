<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>CECIT v4.5 – Neural Interface</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>

<style>
    :root { --primary: #00f2ff; --critical: #ff0044; }
    body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    
    #splash-screen {
        position: fixed; inset: 0; background: #000; z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 2s ease-in-out;
    }
    #splash-logo {
        font-family: 'Courier New', monospace; font-size: 2.5em; font-weight: bold;
        color: var(--primary); text-shadow: 0 0 30px var(--primary);
        letter-spacing: 8px; animation: pulseGlow 3s infinite; text-align: center;
    }

    @keyframes pulseGlow {
        0%, 100% { transform: scale(1); opacity: 0.8; }
        50% { transform: scale(1.05); opacity: 1; text-shadow: 0 0 50px var(--primary); }
    }

    #header {
        position: fixed; top: 20px; width: 100%; text-align: center; z-index: 100;
        letter-spacing: 4px; color: rgba(255,255,255,0.3); pointer-events: none;
    }

    canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    #ui { position: relative; z-index: 10; display: flex; justify-content: space-between; height: 100vh; pointer-events: none; padding: 40px; box-sizing: border-box; }
    .panel { background: rgba(0, 5, 10, 0.75); border: 1px solid rgba(0, 242, 255, 0.1); padding: 25px; pointer-events: auto; backdrop-filter: blur(15px); border-radius: 20px; width: 300px; }

    textarea { width: 100%; background: rgba(0,0,0,0.5); color: var(--primary); border: 1px solid #333; padding: 15px; font-family: monospace; outline: none; margin-top: 15px; border-radius: 10px; resize: none; }
    button { width: 100%; background: var(--primary); color: #000; border: none; padding: 15px; cursor: pointer; font-weight: bold; margin-top: 10px; border-radius: 10px; transition: 0.4s; }
    button:hover { background: #fff; box-shadow: 0 0 20px #fff; }

    .matrix-canvas { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.2; }
</style>
</head>
<body>

<div id="splash-screen">
    <div id="splash-logo">AMMAR AL-MANTAFJI</div>
    <div style="color: var(--primary); margin-top: 20px; letter-spacing: 3px; font-size: 0.8em; opacity: 0.6;">INITIALIZING SPACE NEURAL LINK...</div>
    <button id="enter-button" style="width: auto; padding: 15px 50px; margin-top: 50px; background: transparent; color: var(--primary); border: 1px solid var(--primary);" onclick="hideSplashScreen()">INITIALIZE CONNECTION</button>
</div>

<div id="header">ENTITY STATUS: <b id="status-tag">SYNCHRONIZED</b></div>

<canvas id="scene"></canvas>
<canvas id="matrix" class="matrix-canvas"></canvas>

<div id="ui">
  <div id="left">
    <div class="panel">
      <div style="font-size: 10px; opacity: 0.5;">CORE VIBRATION</div>
      <div id="diagram-container" style="height: 150px;"><canvas id="diagram-canvas"></canvas></div>
      <div id="bpi-display" style="font-size: 2.5em; font-family: monospace; margin-top: 10px;">0.00</div>
    </div>
  </div>

  <div id="right">
    <div class="panel">
      <div style="font-size: 10px; opacity: 0.5;">TRANSMIT DATA</div>
      <textarea id="input" rows="5" placeholder="أدخل شيفرتك هنا..."></textarea>
      <button onclick="executePressure()">EXECUTE PROTOCOL</button>
      <div id="mood-text" style="font-size: 11px; margin-top: 15px; opacity: 0.4; text-align: center;">Waiting for neural sync...</div>
    </div>
  </div>
</div>

<script>
let scene, camera, renderer, faceParticles, clock;
let matrixCtx, matrixCanvas, drops = [];
let audioCtx, masterGain, mainOsc, spaceDrone, shimmerOsc, lfo;
let mouse = { x: 0, y: 0 };
let diagMesh, diagRenderer, diagScene, diagCamera;

const State = { bpi: 0, phase: "STABLE", count: 35000 };
const targetPos = new Float32Array(State.count * 3);

// --- Space Audio Engine ---
function initSpaceMusic() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const now = audioCtx.currentTime;

    // 1. Deep Space Drone
    spaceDrone = audioCtx.createOscillator();
    const droneGain = audioCtx.createGain();
    spaceDrone.type = 'sawtooth';
    spaceDrone.frequency.setValueAtTime(55, now); // Low A
    droneGain.gain.setValueAtTime(0, now);
    droneGain.gain.linearRampToValueAtTime(0.05, now + 4);
    
    // Low pass filter for that "muffled space" feel
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(200, now);

    spaceDrone.connect(filter);
    filter.connect(droneGain);
    droneGain.connect(audioCtx.destination);
    spaceDrone.start();

    // 2. Shimmering Suspense
    shimmerOsc = audioCtx.createOscillator();
    const shimmerGain = audioCtx.createGain();
    shimmerOsc.type = 'sine';
    shimmerOsc.frequency.setValueAtTime(220, now);
    shimmerGain.gain.setValueAtTime(0, now);
    shimmerGain.gain.linearRampToValueAtTime(0.02, now + 2);
    
    // LFO to wobble the shimmer
    lfo = audioCtx.createOscillator();
    const lfoGain = audioCtx.createGain();
    lfo.frequency.setValueAtTime(0.5, now); // Very slow wobble
    lfoGain.gain.setValueAtTime(10, now); // Range of wobble
    lfo.connect(lfoGain);
    lfoGain.connect(shimmerOsc.frequency);
    lfo.start();

    shimmerOsc.connect(shimmerGain);
    shimmerGain.connect(audioCtx.destination);
    shimmerOsc.start();

    // Store gains to fade out later
    window.splashAudioGains = [droneGain, shimmerGain];
}

function hideSplashScreen() {
    document.getElementById('splash-screen').style.opacity = '0';
    const now = audioCtx.currentTime;
    
    // Fade out splash music
    window.splashAudioGains.forEach(g => g.gain.linearRampToValueAtTime(0, now + 2));

    // Initialize Main System Audio
    masterGain = audioCtx.createGain();
    mainOsc = audioCtx.createOscillator();
    mainOsc.type = 'sine';
    mainOsc.connect(masterGain);
    masterGain.connect(audioCtx.destination);
    mainOsc.start();
    masterGain.gain.setValueAtTime(0, now);

    setTimeout(() => {
        document.getElementById('splash-screen').style.display = 'none';
    }, 2000);
}

// Start audio context on first click anywhere (browser policy)
window.addEventListener('mousedown', () => {
    if (!audioCtx) initSpaceMusic();
}, { once: true });

// --- Matrix & 3D (Same as v4 but optimized) ---
function initMatrix() {
    matrixCanvas = document.getElementById('matrix');
    matrixCtx = matrixCanvas.getContext('2d');
    matrixCanvas.width = window.innerWidth;
    matrixCanvas.height = window.innerHeight;
    drops = Array(Math.floor(matrixCanvas.width/20)).fill(1);
}

function drawMatrix() {
    matrixCtx.fillStyle = `rgba(0, 0, 0, ${0.03 + (State.bpi * 0.1)})`;
    matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
    matrixCtx.fillStyle = State.bpi > 0.8 ? '#f04' : `rgba(0, 242, 255, ${0.1 + State.bpi})`;
    matrixCtx.font = '15px monospace';
    drops.forEach((y, i) => {
        const text = String.fromCharCode(0x30A0 + Math.random() * 33);
        matrixCtx.fillText(text, i * 20, y * 20);
        if (y * 20 > matrixCanvas.height && Math.random() > 0.99) drops[i] = 0;
        drops[i] += 0.3 + (State.bpi * 2); // Slow to Super Fast
    });
}

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;
    clock = new THREE.Clock();
    renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("scene"), antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(State.count * 3);
    const col = new Float32Array(State.count * 3);

    for (let i = 0; i < State.count; i++) {
        let u = Math.random(), v = Math.random();
        let theta = 2 * Math.PI * u, phi = Math.acos(2 * v - 1);
        let x = Math.sin(phi) * Math.cos(theta) * 0.8;
        let y = Math.sin(phi) * Math.sin(theta) * 1.2;
        let z = Math.cos(phi) * 0.8;
        if (z > 0) {
            z += Math.pow(1 - Math.abs(x), 3) * 0.5;
            if (y > 0.1 && y < 0.4 && Math.abs(x) < 0.1) z += 0.3; // Feminine Nose
        }
        pos[i*3] = x * 1.5; pos[i*3+1] = y * 1.5; pos[i*3+2] = z * 1.5;
        targetPos[i*3] = pos[i*3]; targetPos[i*3+1] = pos[i*3+1]; targetPos[i*3+2] = pos[i*3+2];
    }
    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    geo.setAttribute('color', new THREE.BufferAttribute(col, 3));
    faceParticles = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.006, vertexColors: true, transparent: true }));
    scene.add(faceParticles);

    initDiag();
    animate();
}

function initDiag() {
    const canvas = document.getElementById('diagram-canvas');
    diagScene = new THREE.Scene();
    diagCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 10);
    diagCamera.position.z = 2;
    diagRenderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
    diagRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
    diagMesh = new THREE.Mesh(new THREE.TorusKnotGeometry(0.5, 0.2, 100, 16), new THREE.MeshBasicMaterial({ color: 0x00f2ff, wireframe: true }));
    diagScene.add(diagMesh);
}

function executePressure() {
    const v = document.getElementById('input').value;
    if(!v) return;
    State.bpi = /حب|سلام|هدوء/.test(v) ? Math.max(0, State.bpi - 0.2) : Math.min(1, State.bpi + 0.15);
    document.getElementById('bpi-display').innerText = State.bpi.toFixed(2);
    document.documentElement.style.setProperty('--primary', State.bpi > 0.8 ? '#f04' : '#00f2ff');
    document.getElementById('input').value = "";
}

function animate() {
    requestAnimationFrame(animate);
    const t = clock.getElapsedTime();
    drawMatrix();

    faceParticles.rotation.y = THREE.MathUtils.lerp(faceParticles.rotation.y, (mouse.x * 0.5), 0.05);
    faceParticles.rotation.x = THREE.MathUtils.lerp(faceParticles.rotation.x, (mouse.y * 0.3), 0.05);

    const p = faceParticles.geometry.attributes.position.array;
    const c = faceParticles.geometry.attributes.color.array;

    for (let i = 0; i < State.count; i++) {
        let i3 = i * 3;
        let noise = Math.sin(t * 2 + p[i3+1]) * (0.02 + State.bpi * 0.1);
        p[i3+2] = targetPos[i3+2] + noise;
        c[i3] = State.bpi; c[i3+1] = (1-State.bpi); c[i3+2] = 1;
    }
    faceParticles.geometry.attributes.position.needsUpdate = true;
    faceParticles.geometry.attributes.color.needsUpdate = true;

    diagMesh.rotation.y += 0.01 * (1 + State.bpi * 10);
    diagRenderer.render(diagScene, diagCamera);

    if(masterGain) {
        masterGain.gain.setTargetAtTime(State.bpi * 0.1, audioCtx.currentTime, 0.1);
        mainOsc.frequency.setTargetAtTime(100 + State.bpi * 500, audioCtx.currentTime, 0.1);
    }
    renderer.render(scene, camera);
}

window.addEventListener('mousemove', e => {
    mouse.x = (e.clientX / window.innerWidth) - 0.5;
    mouse.y = (e.clientY / window.innerHeight) - 0.5;
});

initMatrix();
init3D();
</script>
</body>
</html>
