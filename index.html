<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>CECIT v2 – Human Collapse</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>

<style>
    body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; }
    #scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    #ui { position: relative; z-index: 10; display: grid; grid-template-columns: 1fr 1fr; height: 100vh; pointer-events: none; }
    #left, #right { padding: 30px; }
    .panel { background: rgba(0, 0, 0, 0.85); border: 2px solid #1a1a1a; padding: 20px; margin-bottom: 20px; pointer-events: auto; backdrop-filter: blur(15px); border-radius: 4px; }
    textarea { width: 100%; background: #050505; color: #00ff00; border: 1px solid #333; padding: 15px; font-family: monospace; font-size: 16px; outline: none; }
    button { width: 100%; background: #111; color: #fff; border: 1px solid #444; padding: 12px; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 10px; transition: 0.3s; }
    button:hover { background: #333; }
    #btn-send:hover { background: #ff0000; color: #000; }
    #btn-reset { background: #0044ff; color: white; display: none; } /* يظهر فقط عند الانهيار */
    #bpi-val { font-size: 2.5em; font-weight: bold; color: #00f2ff; }
    .critical { color: #ff0000 !important; animation: blink 0.2s infinite; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.1; } 100% { opacity: 1; } }
</style>
</head>
<body>

<canvas id="scene"></canvas>

<div id="ui">
  <div id="left">
    <div class="panel">
      <div style="color:#666">مستوى الضغط (BPI)</div>
      <div id="bpi-val">0.00</div>
      <div style="margin-top:20px;">الحالة: <span id="phase">STABLE</span></div>
      <button id="btn-reset" onclick="resetSystem()">إعادة تشغيل النظام ↺</button>
    </div>
  </div>

  <div id="right">
    <div class="panel">
      <b style="color:#ff0000">بروتوكول التحكم</b>
      <textarea id="input" rows="4" placeholder="اكتب '0' للاستقرار أو كلمات للهدم..."></textarea>
      <button id="btn-send">بث الضغط</button>
    </div>
  </div>
</div>

<script>
let scene, camera, renderer, particles, clock;
let audioCtx, masterGain, oscillator;
const State = { bpi: 0, phase: "STABLE", count: 8000 };
const initialPositions = new Float32Array(State.count * 3);

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 4;
    clock = new THREE.Clock();

    renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("scene"), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(State.count * 3);
    const colors = new Float32Array(State.count * 3);

    for (let i = 0; i < State.count; i++) {
        let x, y, z;
        // تشكيل ملامح وجه (بيضاوي للرأس مع تجاويف للعين)
        const phi = Math.acos(-1 + (2 * i) / State.count);
        const theta = Math.sqrt(State.count * Math.PI) * phi;
        
        x = Math.cos(theta) * Math.sin(phi) * 1.2;
        y = Math.sin(theta) * Math.sin(phi) * 1.5; // تطويل الوجه
        z = Math.cos(phi) * 1.2;

        // دفع الجزيئات للأمام لتشكيل الأنف والوجه
        if (z > 0) z += Math.sin(y * 2) * 0.3; 

        positions[i*3] = x;
        positions[i*3+1] = y;
        positions[i*3+2] = z;
        
        initialPositions[i*3] = x;
        initialPositions[i*3+1] = y;
        initialPositions[i*3+2] = z;

        colors[i*3] = 0; colors[i*3+1] = 0.8; colors[i*3+2] = 1;
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    const material = new THREE.PointsMaterial({ size: 0.015, vertexColors: true, transparent: true });
    particles = new THREE.Points(geometry, material);
    scene.add(particles);
    animate();
}

function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);
    oscillator = audioCtx.createOscillator();
    oscillator.type = 'sawtooth';
    oscillator.start();
    oscillator.connect(masterGain);
    masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
}

function resetSystem() {
    State.bpi = 0;
    State.phase = "STABLE";
    document.getElementById("btn-reset").style.display = "none";
    document.getElementById("bpi-val").className = "";
    document.getElementById("phase").className = "";
    updateUI();
}

function updateUI() {
    const bpiEl = document.getElementById("bpi-val");
    const phaseEl = document.getElementById("phase");
    bpiEl.innerText = State.bpi.toFixed(2);
    phaseEl.innerText = State.phase;

    if (State.bpi >= 0.9) {
        State.phase = "COLLAPSE";
        bpiEl.className = "critical";
        document.getElementById("btn-reset").style.display = "block";
    }
}

document.getElementById("btn-send").onclick = () => {
    initAudio();
    const val = document.getElementById("input").value.trim();
    
    if (val === "0") {
        resetSystem();
    } else {
        State.bpi = Math.min(State.bpi + 0.2, 1.0);
    }
    updateUI();
    document.getElementById("input").value = "";
};

function animate() {
    requestAnimationFrame(animate);
    const time = clock.getElapsedTime();
    const pos = particles.geometry.attributes.position.array;
    const col = particles.geometry.attributes.color.array;

    for (let i = 0; i < State.count; i++) {
        const i3 = i * 3;
        if (State.bpi < 0.9) {
            // العودة للشكل الأصلي أو حركة بسيطة
            pos[i3] += (initialPositions[i3] - pos[i3]) * 0.1;
            pos[i3+1] += (initialPositions[i3+1] - pos[i3+1]) * 0.1;
            pos[i3+2] += (initialPositions[i3+2] - pos[i3+2]) * 0.1;
            col[i3] = State.bpi; col[i3+1] = 0.8 - State.bpi; col[i3+2] = 1 - State.bpi;
        } else {
            // انفجار سريع جداً
            pos[i3] += (Math.random() - 0.5) * 1.5;
            pos[i3+1] += (Math.random() - 0.5) * 1.5;
            pos[i3+2] += (Math.random() - 0.5) * 1.5;
            col[i3] = 1; col[i3+1] = 0; col[i3+2] = 0;
        }
    }
    particles.geometry.attributes.position.needsUpdate = true;
    particles.geometry.attributes.color.needsUpdate = true;
    particles.rotation.y += 0.005 + (State.bpi * 0.2); // تسريع الدوران

    if (audioCtx) {
        masterGain.gain.setTargetAtTime(State.bpi * 0.15, audioCtx.currentTime, 0.1);
        oscillator.frequency.setTargetAtTime(40 + (State.bpi * 800), audioCtx.currentTime, 0.1);
    }
    renderer.render(scene, camera);
}

init3D();
</script>
</body>
</html>
