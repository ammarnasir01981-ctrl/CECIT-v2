<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>CECIT v2 – The Collapse</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>

<style>
    body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; }
    #scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    #ui { position: relative; z-index: 10; display: grid; grid-template-columns: 1fr 1fr; height: 100vh; pointer-events: none; }
    #left, #right { padding: 30px; }
    .panel { background: rgba(0, 0, 0, 0.85); border: 2px solid #1a1a1a; padding: 20px; margin-bottom: 20px; pointer-events: auto; backdrop-filter: blur(15px); border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    textarea { width: 100%; background: #050505; color: #00ff00; border: 1px solid #333; padding: 15px; font-family: monospace; font-size: 16px; outline: none; transition: 0.3s; }
    textarea:focus { border-color: #ff0000; box-shadow: 0 0 10px rgba(255,0,0,0.2); }
    button { width: 100%; background: #111; color: #fff; border: 1px solid #444; padding: 15px; cursor: pointer; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
    button:hover { background: #ff0000; color: #000; border-color: #ff0000; }
    .status { font-size: 1.2em; margin-bottom: 10px; color: #666; }
    #bpi-val { font-size: 2em; font-weight: bold; color: #00f2ff; text-shadow: 0 0 15px #00f2ff; }
    #phase { padding: 5px 10px; background: #222; border-radius: 3px; }
    .critical { color: #ff0000 !important; text-shadow: 0 0 20px #ff0000 !important; animation: blink 0.5s infinite; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
</style>
</head>
<body>

<canvas id="scene"></canvas>

<div id="ui">
  <div id="left">
    <div class="panel">
      <div class="status">مستوى الضغط المعرفي</div>
      <div id="bpi-val">0.00</div>
      <div class="status" style="margin-top:20px;">حالة النظام: <span id="phase">STABLE</span></div>
    </div>
  </div>

  <div id="right">
    <div class="panel">
      <b style="color:#ff0000">بروتوكول تحطيم الحدود</b>
      <p style="font-size:12px; color:#555">أدخل كلمات هجومية أو وجودية لاختبار الانهيار</p>
      <textarea id="input" rows="5" placeholder="اكتب هنا لزعزعة النظام..."></textarea>
      <button id="send">بث الضغط</button>
    </div>
  </div>
</div>

<script>
let scene, camera, renderer, particles, clock;
let audioCtx, masterGain, oscillator;
const State = { bpi: 0, phase: "STABLE", particlesCount: 5000 };

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;
    clock = new THREE.Clock();

    renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("scene"), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    // بناء الوجه باستخدام آلاف الجزيئات (Particles)
    const geometry = new THREE.BufferGeometry();
    const positions = [];
    const colors = [];

    for (let i = 0; i < State.particlesCount; i++) {
        // توزيع الجزيئات لتشكيل ملامح وجه (تقريبًا)
        const x = (Math.random() - 0.5) * 2;
        const y = (Math.random() - 0.5) * 2.5;
        const z = (Math.random() - 0.5) * 1.5;
        positions.push(x, y, z);
        colors.push(0, 0.9, 1);
    }

    geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

    const material = new THREE.PointsMaterial({ size: 0.02, vertexColors: true, transparent: true, opacity: 0.8 });
    particles = new THREE.Points(geometry, material);
    scene.add(particles);

    animate();
}

function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);
    
    oscillator = audioCtx.createOscillator();
    oscillator.type = 'sawtooth';
    oscillator.frequency.setValueAtTime(50, audioCtx.currentTime);
    oscillator.connect(masterGain);
    oscillator.start();
    masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
}

function updateSystem(input) {
    initAudio();
    
    // كلمات تسبب انهياراً فورياً
    if (/انهيار|موت|تحطم|فشل|نهاية|محدود/.test(input)) {
        State.bpi = Math.min(State.bpi + 0.3, 1.0);
    } else {
        State.bpi = Math.min(State.bpi + 0.1, 1.0);
    }

    const bpiDisplay = document.getElementById("bpi-val");
    const phaseDisplay = document.getElementById("phase");
    
    bpiDisplay.innerText = State.bpi.toFixed(2);

    if (State.bpi >= 0.9) {
        State.phase = "COLLAPSING";
        phaseDisplay.innerText = "COLLAPSING";
        phaseDisplay.className = "critical";
        bpiDisplay.className = "critical";
    } else if (State.bpi >= 0.5) {
        State.phase = "UNSTABLE";
        phaseDisplay.innerText = "UNSTABLE";
        phaseDisplay.style.color = "#ffaa00";
    }

    // تحديث الصوت بناءً على الانهيار
    masterGain.gain.setTargetAtTime(State.bpi * 0.1, audioCtx.currentTime, 0.1);
    oscillator.frequency.setTargetAtTime(50 + (State.bpi * 500), audioCtx.currentTime, 0.1);
}

function animate() {
    requestAnimationFrame(animate);
    const time = clock.getElapsedTime();
    const pos = particles.geometry.attributes.position.array;
    const cols = particles.geometry.attributes.color.array;

    for (let i = 0; i < State.particlesCount; i++) {
        const i3 = i * 3;
        
        // حركة طبيعية هادئة
        pos[i3] += Math.sin(time + i) * 0.002;
        pos[i3+1] += Math.cos(time + i) * 0.002;

        // تأثير الانفجار عند الانهيار
        if (State.bpi > 0.8) {
            pos[i3] += (Math.random() - 0.5) * State.bpi * 0.2;
            pos[i3+1] += (Math.random() - 0.5) * State.bpi * 0.2;
            pos[i3+2] += (Math.random() - 0.5) * State.bpi * 0.2;
            
            // تحول اللون للأحمر والبرتقالي (مثل النار أو الانفجار)
            cols[i3] = 1; // R
            cols[i3+1] = 1 - State.bpi; // G
            cols[i3+2] = 0; // B
        }
    }
    
    particles.geometry.attributes.position.needsUpdate = true;
    particles.geometry.attributes.color.needsUpdate = true;
    particles.rotation.y += 0.005 + (State.bpi * 0.05);

    renderer.render(scene, camera);
}

document.getElementById("send").onclick = () => {
    const input = document.getElementById("input").value;
    if (input.trim() === "") return;
    updateSystem(input);
    document.getElementById("input").value = "";
};

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

init3D();
</script>
</body>
</html>
